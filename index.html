<!DOCTYPE html>
<html>
<head>
	<title>File Upload</title>

	<style type="text/css">
		body {
			margin: 0 auto;
			max-width: 40em;
			width: 88%;
		}

		label,
		input {
			display: block;
			width: 100%;
		}

		input {
			margin-bottom: 1em;
		}

		#app {
			margin-bottom: 1em;
		}

		img {
			height: auto;
			max-width: 100%;
		}
	</style>
</head>
<body>

	<h1>File Upload</h1>

	<div id="app"></div>

	<form id="upload">
		<label for="file">File to upload</label>
		<input type="file" id="file" accept="image/*">

		<button>Upload</button>
	</form>

	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
	<script>
		// Get the form and file field
		let form = document.querySelector('#upload');
		let file = document.querySelector('#file');
		let app = document.querySelector('#app');
		var albumBucketName = "awk-rekognition-project";
		var bucketRegion = "us-east-1";
		var IdentityPoolId = "us-east-1_KZz2c0GOI";
		
		AWS.config.update({
			region: bucketRegion,
			credentials: new AWS.CognitoIdentityCredentials({
			IdentityPoolId: IdentityPoolId
			})
		});

		var s3 = new AWS.S3({
			apiVersion: "2006-03-01",
			params: { Bucket: albumBucketName }
		});
		
		/**
		 * Log the uploaded file to the console
		 * @param {event} Event The file loaded event
		 */
		function logFile (event) {
			let str = event.target.result;
			let img = document.createElement('img');
			img.src = str;
			app.append(img);
			console.log(str);
		}

		/**
		 * Handle submit events
		 * @param  {Event} event The event object
		 */
		function handleSubmit (event) {

			// Stop the form from reloading the page
			event.preventDefault();
			
			var myfile = file.files[0];
			var fileName = event.target.result;
			var photoKey = fileName;
			
			// If there's no file, do nothing
			if (!file.value.length) return;

			// Create a new FileReader() object
			let reader = new FileReader();

			// Setup the callback event to run when the file is read
			reader.onload = logFile;

			// Read the file
			reader.readAsDataURL(myfile);
			
			//Upload to s3
			var upload = new AWS.S3.ManagedUpload({
				params: {
				  Bucket: albumBucketName,
				  Key: photoKey,
				  Body: myfile
				}
			});
			
			 var promise = upload.promise();

		    promise.then(
				function(data) {
					alert("Successfully uploaded photo.");
				},
				function(err) {
					return alert("There was an error uploading your photo: ", err.message);
				}
			);
		}

		// Listen for submit events
		form.addEventListener('submit', handleSubmit);
	</script>
</body>
</html>